@model UNO.AppModel.RoleMenuAccess

@{
    ViewBag.Title = "Role Menu Access";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section scripts
{
    <script>

        var uri = '@System.Configuration.ConfigurationManager.AppSettings["APIUrl"].ToString()';
        $(document).ready(function () {
            if ('@ViewBag.CreateAccess' == "False") {
                $(".btnCreateNew").hide();
            }
            if ('@ViewBag.ViewAccess' == "False") {
                $(".btn-success").hide();
            }
            if ('@ViewBag.EditAccess' == "False") {
                $(".btn-info").hide();
            }
            if ('@ViewBag.DeleteAccess' == "False") {
                $(".btn-danger").hide();
            }

            $("#lsttable").DataTable(
                          {
                              "sPaginationType": "full_numbers",
                              oLanguage: {
                                  sLengthMenu: "Show: _MENU_",
                              },
                              pageLength: 10,
                              "aoColumns": [
                                           null,
                                           null,
                                           null,
                                           null,
                                            { "bSortable": false },
                                            { "bSortable": false },
                                            { "bSortable": false },
                                            { "bSortable": false }
                              ]
                          });
            BindRoleByID();
        });


        function BindRoleByID() {
            debugger;
            var RecordID = $('#ROLE_ID').val();
            if (true) {

            }
            $.ajax({
                type: "GET",
                contentType: "application/json;charset=utf-8",
                url: uri + "MenuAccessAPI/GetAllMenuRoleWise/" + RecordID,
                dataType: "json",

                success: function (roleMenuAccess, status, jqXHR) {
                    var str = "";
                    if (roleMenuAccess != undefined) {
                        debugger;
                        roleMenuAccess.forEach(function (response) {
                            str += "<tr>" +
                            //"<td style='display:none'>" + response.ROLE_ACCESS_ID + "</td>" +
                            //"<td style='display:none'>" + response.ROLE_ID + "</td>" +
                            //"<td style='display:none'>" + response.MENU_ID + "</td>" +
                            //"<td class='text-center'>" + response.MENU_NAME + "</td>" +
                              "<td>" + response.ROLE_ACCESS_ID + "</td>" +
                            "<td>" + response.ROLE_ID + "</td>" +
                            "<td>" + response.MENU_ID + "</td>" +
                            "<td>" + response.MENU_NAME + "</td>" +
                            "<td class='text-center'> <input id='chk_" + response.MENU_ID + "_Read'  type=checkbox " + (response.ViewAccess == 1 ? 'checked' : '') + " /></td>" +
                            "<td class='text-center'> <input id='chk_" + response.MENU_ID + "_Create'  type=checkbox " + (response.CreateAccess == 1 ? 'checked' : '') + " /></td>" +
                            "<td class='text-center'> <input id='chk_" + response.MENU_ID + "_Update' type=checkbox  " + (response.UpdateAccess == 1 ? 'checked' : '') + " /></td>" +
                            "<td class='text-center'> <input id='chk_" + response.MENU_ID + "_Delete' type=checkbox  " + (response.DeleteAccess == 1 ? 'checked' : '') + " /></td>" +

                            "</tr>";
                        });
                    }

                    if ($.fn.dataTable.isDataTable('#lsttable')) {
                        var table = $('#lsttable').DataTable();

                        table.clear();
                        table.destroy();

                        $("#data").html(str);


                        $("#lsttable").DataTable(
                               {
                                   "sPaginationType": "full_numbers",
                                   "order": [[1, "desc"]],
                                   oLanguage: {
                                       sLengthMenu: "Show: _MENU_",
                                   },
                                   pageLength: 10,
                                   "aoColumns": [
                                                null,
                                                null,
                                                null,
                                                null,
                                                 { "bSortable": false },
                                                 { "bSortable": false },
                                                 { "bSortable": false },
                                                 { "bSortable": false }
                                   ]
                               });
                    }
                },
                error: function (xhr, status, error) {

                }

            });


            $(document).on('change', '[type=checkbox]', function () {
                var chkObject = $(this);
                var id = chkObject[0].id;
                var IdArr = new Array();
                if (id != null) {
                    IdArr = id.split('_');
                    var ReadChk = IdArr[0] + "_" + IdArr[1] + "_Read";
                    var UpdateChk = IdArr[0] + "_" + IdArr[1] + "_Update";;
                    var DeleteChk = IdArr[0] + "_" + IdArr[1] + "_Delete";;
                    var CreateChk = IdArr[0] + "_" + IdArr[1] + "_Create";
                    if (IdArr[2] == "Read") {
                        if (!document.getElementById(ReadChk).checked) {
                            document.getElementById(UpdateChk).checked = false;
                            document.getElementById(DeleteChk).checked = false;
                            document.getElementById(CreateChk).checked = false;
                        } else {
                            //document.getElementById(UpdateChk).checked = true;
                            //document.getElementById(DeleteChk).checked = true;
                            //document.getElementById(CreateChk).checked = true;
                        }

                    } else if (IdArr[2] == "Create" || IdArr[2] == "Update" || IdArr[2] == "Delete") {
                        if (!document.getElementById(ReadChk).checked) {
                            document.getElementById(ReadChk).checked = true;
                        }
                    }
                }
            });
        }

        @*$('#frm-example').on('submit', function (e) {
            // Prevent actual form submission
            var table = $('#lsttable').DataTable();
          //  e.preventDefault();
            debugger;
            // Serialize form data
            var data = table.$('input,select,checkbox').serialize();
            alert(data);
            $.ajax({
                type: "POST",
                contentType: "application/json;charset=utf-8",//type of data to be send
                //url: "http://localhost:8487/GridLogikViewerWebAPI/api/rolemenuaccess/" + RecordID,
                url: BaseAddress + "MenuAccessAPI1/",
                //crossDomain: true,
                data: JSON.stringify(data),
                dataType: "json",//type of data to be received
                success: function (response) {

                    if (response.Data.e == "S") {

                        if (response.Data.d.length > 0)
                            alert(response.Data.d, '@Url.Action("Index", "RoleMenuAccess")', true, response.Data.e);
                        //window.location.href = '@Url.Action("Index", "RoleMenuAccess")';
                    }
                    else if (response.Data.e == "M") {

                        if (response.Data.d.length > 0)
                            alert(response.Data.d, '', false, response.Data.e);
                    }
                    else if (response.Data.e == "E") {

                        if (response.Data.d.length > 0)
                            alert(response.Data.d, '', false, response.Data.e);
                    }
                },
                error: function (xhr, status, error) {
                    alert(xhr.responseText);
                }
            });
        })*@

        $("#btnCreate").click(function (e) {
            debugger;
            var RecordID = $('#ROLE_ID').val();
            debugger;
            if (RecordID == "0") {
                //alert('Please Select Role');
                alert('Please Select Role', '', false, "M");
                return false;
            }

            var TableData = new Array();
            e.preventDefault();
            //var data = table.$('input,select,textarea').serializeArray();
            $('.lsttable').attr('iDisplayLength', 50);

            $('#lsttable tbody tr').each(function (row, tr) {

                TableData[row] = {
                    "rmaroleid": RecordID //$(tr).find('td:eq(1)').text()
                    , "rmaroleaccessid": $(tr).find('td:eq(0)').text()
                    , "rmamnuid": $(tr).find('td:eq(2)').text()
                    , "rmareadaccess": $(tr).find('td:eq(4) input:first').is(':checked')
                    , "rmacreateaccess": $(tr).find('td:eq(5) input:first').is(':checked')
                    , "rmaupdateaccess": $(tr).find('td:eq(6) input:first').is(':checked')
                    , "rmadeleteaccess": $(tr).find('td:eq(7) input:first').is(':checked')

                }

            });

            $.ajax({
                type: "POST",
                contentType: "application/json;charset=utf-8",//type of data to be send
                //url: "http://localhost:8487/GridLogikViewerWebAPI/api/rolemenuaccess/" + RecordID,
                url: uri + "MenuAccessAPI/",
                //crossDomain: true,
                data: JSON.stringify(TableData),
                dataType: "json",//type of data to be received
                success: function (response, status, jqXHR) {
                    debugger;
                    if (status == "success") {
                        debugger;
                        $("#trgPopup").html("<button id='btn-success-trigger' type='button' class='btn btn-popup-success collapse' data-toggle='modal' data-target='#modal_message' data-dismiss='modal'><i class='fa fa-check'></i>&nbsp;</button>");
                        $("#btn-success-trigger").trigger('click');
                        $("#modal_message h3").text("Success");
                        BindRoleByID();
                    }

                    //ViewBag.Message = "<button id='btn-success-trigger' type='button' class='btn btn-popup-success collapse' data-toggle='modal' data-target='#modal_message' data-dismiss='modal'><i class='fa fa-check'></i>&nbsp;</button>";



                },
                error: function (xhr, status, error) {
                    alert(xhr.responseText);
                }
            });


        })

    </script>
}

<!-- Container fluid Starts -->
<!-- Main Container starts -->
<div id="trgPopup">

</div>

<form name="frm-example" id="frm-example">
    <div class="main-container" style="clear:both;">
        <!-- Container fluid Starts -->
        <div class="container-fluid">
            <!-- Spacer Starts -->
            <div class="spacer clearfix">
                <div class="row">
                    <div class="col-md-12">
                        <div class="blog blog-default ">
                            <div class="blog-header ">
                                <h4 class="blog-title pull-left mt5">Listing </h4>
                                <span class="clearfix"></span>
                            </div>
                            <div class="blog-body">

                                <div class="table-responsive">
                                    <div id="dt_example" class="table-responsive example_alt_pagination clearfix">
                                        <div class="col-sm-3">
                                            <div class="form-group row">
                                                <label class="col-md-4 form-control-label mt5"> Level Code </label>
                                                <div class="col-sm-8">
                                                    @Html.DropDownListFor(model => model.ROLE_ID, (IEnumerable<SelectListItem>)ViewBag.RoleId, "Select Level", new { @class = "form-control", @onchange = "BindRoleByID()" })
                                                    @Html.ValidationMessageFor(model => model.ROLE_ID, null, new { @class = "text-danger field-validation-error" })
                                                </div>
                                            </div>
                                        </div>
                                        <table id="lsttable" class="table table-condensed table-striped table-hover table-bordered pull-left">
                                            <thead>
                                                <tr>
                                                    @*<th class="text-center" style='display:none'>ROLE_ACCESS_ID</th>
                                                        <th class="text-center" style='display:none'>Role_ID</th>
                                                        <th class="text-center" style='display:none'>MENU_ID</th>*@
                                                    <th class="text-center">ROLE_ACCESS_ID</th>
                                                    <th class="text-center">Role_ID</th>
                                                    <th class="text-center">MENU_ID</th>
                                                    <th class="text-center">MENU NAME</th>
                                                    <th class="text-center">VIEW ACCESS</th>
                                                    <th class="text-center">ADD ACCESS</th>
                                                    <th class="text-center">EDIT ACCESS</th>
                                                    <th class="text-center">DELETE ACCESS</th>
                                                </tr>
                                            </thead>
                                            <tbody id="data"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="form-actions">
                                <div class="row">
                                    <div class="col-md-12 text-center">
                                        <button id="btnCreate" type="submit" class="btn btn-info">
                                            <i class="fa fa-save"></i> Save
                                        </button>
                                        <button type="button" class="btn default"><i class="fa fa-refresh"></i>  Reset</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>
